{{/*  Navigation that displays in the body of a page (If applicable).  */}}
{{/*  {{ if .Params.submenu }}
    <nav class="container inner-nav">
        <ul class="inner-nav-ul">
            {{ range .Params.submenu }}
                <li class="inner-nav-li">
                    <a href="{{ .url }}" class="inner-nav-a">{{ .name }}</a>
                </li>
            {{ end }}
        </ul>
    </nav>
{{ else }}  */}}
    <nav class="container inner-nav">
        <ul class="inner-nav-ul">
            <button id="menu-button" class="menu-button">
                <i class="material-icons">menu</i>
            </button>
            <a href="/" title="ZooBerry" class="nav-logo"></a>
            <div id="search-container" style="position: relative;">
                <input type="text" id="search-box" placeholder="Search mods...">
                <ul id="search-results"></ul>
            </div>
        </ul>
    </nav>
{{/*  {{ end }}  */}}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // clear search box if page reloaded
        const searchBox = document.getElementById('search-box');
        const resultsContainer = document.getElementById('search-results');
      
        searchBox.value = ''; // clear the search box
        resultsContainer.innerHTML = ''; // remove any previous results
      });

    let searchIndex;

    function toProperCase(str) {
        return str
          .split(' ') // Split the string into words
          .map(word => word.charAt(0).toUpperCase() + word.slice(1)) // Capitalize first letter of each word
          .join(' '); // Join the words back into a single string
      }
  
    // get the JSON data
    fetch('/index.json')
      .then(response => response.json())
      .then(data => {
        console.log('Fetched JSON data:', data);
  
        // init Lunr.js
        searchIndex = lunr(function () {
          this.ref('url'); 
          this.field('title');
          this.field('game');
          this.field('mod_list_titles'); 
          this.field('author');
  
          data.forEach(doc => {
            console.log('Adding document to index:', doc);
  
            // combine all mod list titles into a single string
            const aggregatedTitles = doc.mod_list_titles.join(' ');
            this.add({
              title: doc.title.toLowerCase(),
              url: doc.url,
              mod_list_titles: aggregatedTitles.toLowerCase(), // Ensure case-insensitive search
                game: doc.game.toLowerCase(),
                author: doc.author.toLowerCase()
            });
          });
        });
  
        console.log('Lunr.js index initialized:', searchIndex);
  
        // store data in global variable for later retrieval
        window.searchDocs = data.reduce((acc, doc) => {
            acc[doc.url] = {
              ...doc, // Ensure all fields, including 'game', are stored
            };
            return acc;
          }, {});
                })
      .catch(error => console.error('Error fetching or processing JSON:', error));
  
    // live search start
    document.getElementById('search-box').addEventListener('input', function () {
      const query = this.value.trim().toLowerCase();
      const resultsContainer = document.getElementById('search-results');
      resultsContainer.innerHTML = ''; // erase prev results
    
      // if no results, display: none search-results and return
      if (query.length === 0 || !searchIndex) {
        resultsContainer.style.display = 'none';
        return;
      }

        resultsContainer.style.display = 'block';
  
      // wildcard to get partial matches
      const exactMatchResults = searchIndex.search(query);
      const partialResults = searchIndex.search(`*${query}*`)
      // combine exact and partial matches, remove duplicates
      const results = [...new Map([...exactMatchResults, ...partialResults].map(item => [item.ref, item])).values()];
      console.log('Search results:', results);

    // if characters are in search box but no results, "No results found" message
    if (results.length === 0) {
        const listItem = document.createElement('li');
        listItem.textContent = 'No results found';
        resultsContainer.appendChild(listItem);
        return;
    }

  
    results.slice(0, 10).forEach(result => {
        // get the matching document
        const doc = window.searchDocs[result.ref];
        console.log('Matching document:', doc);
  
        const link = document.createElement('a');
        link.href = doc.url;
        // make title proper case
        link.textContent = toProperCase(doc.title);
  
        // add game name to search results
        const author = doc.author ? `by ${doc.author}` : '';
        // if 'zoo tycoon 1' then 'zt1' or 'zoo tycoon 2' then 'zt2'
        const game = doc.game === 'zoo tycoon 1' ? 'ZT1' : doc.game === 'zoo tycoon 2' ? 'ZT2' : '';
        const span = document.createElement('span');
        span.textContent = `${game}`;
        link.appendChild(span);

        // by author
        const author_span = document.createElement('span');
        author_span.textContent = `${author}`;
        link.appendChild(author_span);
        
        // add the link to the search results
        const listItem = document.createElement('li');
        listItem.appendChild(link);
        resultsContainer.appendChild(listItem);
      });
    });
  </script>
  
  <style>
    #search-container {
        width: 100%;
      }

        #search-box {
            width: 80%;
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            outline: none;
        }

        #search-box:hover {
            background-color: #f2f2f2;
        }
      
        #search-results {
            display: none;
            list-style-type: none;
            padding: 10px;
            margin: -4px 0 0;
            position: absolute; 
            top: 100%; 
            left: 0;
            width: 80%;
            background-color: #fff;
            border-radius: 0 0 5px 5px;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto; 
          }
          
          #search-results li {
            margin: 5px 0;
            display: list-item; 
          }
          
          #search-results a {
            text-decoration: none;
            color: var(--thead-bg);
            display: block; 
            padding: 5px;
            background-color: transparent;
          }
          
          #search-results a:hover {
            background-color: #f2f2f2;
          }
          
          /* game name in search results */
            #search-results a span:first-child {
                font-size: 0.8em;
                color: #666;
                margin: 0 5px;
                padding: 2px;
                border-radius: 5px;
                background-color: #f2f2f2;
            }

            /* author in search results italic */
            #search-results a span:last-child {
                font-size: 0.8em;
                color: #666;
                margin: 0 5px;
                padding: 2px;
                border-radius: 5px;
                font-style: italic;
            }


    div.inner-nav {
        display: flex !important;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
    }
                              
  </style>